<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet"
          th:href="@{/styles/global.css}"/>
    <title>Propriedades</title>
</head>

<body>
<div th:insert="~{fragments/sidebar :: sidebar('propriedade')}"></div>

<div class="w-100">
    <div th:insert="~{fragments/header :: header}"></div>

    <div class="page-content-container p-3">
        <div class="page-header border-bottom">
            <h1 th:text="${propriedade.nomePropriedade}"></h1>

            <div class="buttons-wrapper">
                <button type="button"
                        th:attr="data-url=@{/propriedade/cadastrar(idPropriedade=${propriedade.idPropriedade})}"
                        onclick="window.location.href = this.getAttribute('data-url')"
                        class="btn btn-primary">
                    <i class="fa-solid fa-pen-to-square"></i>
                    EDITAR
                </button>
            </div>
        </div>

        <div class="page-content-wrapper">
            <div class="form-wrapper">
                <div class="form-row">
                    <div>
                        <h1>Sobre Propriedade:</h1>
                        <p class="m-0">Nome do Produtor: <span th:text="${propriedade.nomeProdutor}"></span></p>
                        <p class="m-0">Email: <span th:text="${propriedade.email}"
                                                    class="m-0"></span></p>
                        <p class="m-0">Cpf: <span th:text="${propriedade.CPF}"
                                                  class="m-0"></span></p>
                        <p class="m-0">Cnpj: <span th:text="${propriedade.CNPJ}"
                                                   class="m-0"></span></p>
                        <p class="m-0">Telefone: <span th:text="${propriedade.telefone}"
                                                       class="m-0"></span></p>
                        <p class="m-0">Celular: <span th:text="${propriedade.celular}"
                                                      class="m-0"></span></p>
                        <p class="m-0">Selo de identificação</p>
                    </div>
                    <div>
                        <div style="width: 100%">
                            <iframe
                                    id="map"
                                    width="100%"
                                    height="300"
                                    frameborder="0"
                                    style="border:0"
                                    allowfullscreen
                                    aria-hidden="false"
                                    tabindex="0">
                            </iframe>
                        </div>

                    </div>
                </div>

                <div class="form-row">
                    <h1>Endereço</h1>
                    <p class="m-0">Logadouro: <span th:text="${propriedade.UF}"
                                                    class="m-0"></span></p>
                    <p class="m-0">Nome da Rua: <span th:text="${propriedade.rua}"
                                                      class="m-0"></span></p>
                    <p class="m-0">Bairro: <span th:text="${propriedade.bairro}"
                                                 class="m-0"></span></p>
                    <p class="m-0">Numero: <span th:text="${propriedade.UF}"
                                                 class="m-0"></span></p>
                    <p class="m-0">Cidade: <span th:text="${propriedade.cidade}"
                                                 class="m-0"></span></p>
                    <p class="m-0">UF:PR: <span th:text="${propriedade.UF}"
                                                class="m-0"></span></p>
                </div>
            </div>

            <div class="ps-5">
                <label for="selectYear">Selecione o ano:</label>

                <select id="selectYear"
                        onchange="filtrarPorAno(this.value)">
                </select>
            </div>

            <div class="border border-black ms-5 me-5 p-2"
                 id="chart"
                 style="border-radius: 10px; height: 250px; ">
            </div>

            <div class="d-flex flex-column border border-black ms-5 me-5 mt-5"
                 style="border-radius: 10px; height: 500px; ">
                <div style="border-bottom: 1px solid black;">
                    <h1 class="text-center">Amostras</h1>
                </div>
                <div class="h-100 p-2"
                     style="overflow-y: auto;">

                    <table class="table-stripe stripe h-100 w-100"
                           id="myTable">
                        <thead>
                        <tr>
                            <th scope="col">Observação</th>
                            <th scope="col">Data</th>
                            <th scope="col">Leite</th>
                            <th scope="col">Queijo</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody th:if="${propriedade != null}">
                        <tr class="border user-row"
                            th:id="${amostra.getId()}"
                            th:each="amostra, status : ${propriedade.getAmostras()}"
                            th:short="${amostra.getData()}">
                            <td th:text="${amostra.getObservacao()}"></td>
                            <td th:text="${#dates.format(amostra.getData(), 'dd/MM/yyyy')}"></td>
                            <td th:text="${amostra.getQuantidadeleite()}"></td>
                            <td th:text="${amostra.getQuantidadeQueijo()}"></td>
                            <td>
                                <button type="button"
                                        th:onclick="'removerAmostra(\'' + ${amostra.getId()} + '\');'"
                                        class="btn btn-danger rounded-pill px-3 shadow ">
                                    x
                                </button>

                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-center align-items-end p-2"
                     style="border-top: 1px solid black;">
                    <button class="btn btn-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#amostraModal">Adicionar
                    </button>
                </div>
            </div>

            <div class="ms-5 me-5 d-flex justify-content-betwen">
                <div class="w-50 me-2 p-2">
                    <div class="d-flex align-items-center m-2">
                        <p class="m-3 fs-3">Cursos</p>

                    </div>
                    <div class="border border-black w-100 overflow-auto p-3 rounded"
                         style="height: 400px; width: 400px;">

                        <table class="table-stripe stripe"
                               id="cursosTable">
                            <thead>
                            <th scope="col">Nome</th>
                            <th scope="col">Conteudo</th>
                            <th scope="col">Professor</th>
                            <th scope="col">Duração</th>
                            <th scope="col"></th>
                            </tr>
                            </thead>
                            <tbody th:if="${propriedade != null}">
                            <tr class="border tr"
                                th:id="${curso.getId()}"
                                th:each="curso : ${propriedade.getCursos()}">
                                <th class="cursoID"
                                    th:id="${curso.getId()}"
                                    th:text="${curso.getNome()}"></th>
                                <td th:text="${curso.getConteudo()}"></td>
                                <td th:text="${curso.getProfessor()}"></td>
                                <td th:text="${curso.getDuracao()}"></td>
                                <td>

                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="w-50 ms-2 p-2">
                    <div class="d-flex align-items-center m-2">
                        <p class="m-3 fs-3">Tecnologias</p>

                    </div>
                    <div class="border border-black w-100 overflow-auto p-3 rounded"
                         style="height: 400px; width: 400px;">

                        <table class="table-stripe stripe w-100"
                               id="tecnologiasTable">
                            <thead>
                            <th scope="col">Nome</th>
                            <th scope="col"></th>
                            </tr>
                            </thead>
                            <tbody th:if="${propriedade != null}">
                            <tr class="border tr tecnologiaAdd"
                                th:id="${tecnologia.getId()}"
                                th:each="tecnologia : ${propriedade.getTecnologias()}">
                                <th class="tecnologiaID"
                                    th:id="${tecnologia.getId()}"
                                    th:text="${tecnologia.getNome()}"></th>
                                <td>

                                </td>

                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>

                </div>
            </div>

            <div class="border border-black rounded overflow-auto me-5 ms-5 p-2"
                 style="height: 600px; margin-top: 100px;">
                <p class="text-center fs-2">Fornecedores

                </p>

                <table class="table-stripe stripe w-100"
                       id="fornecedorTable">
                    <thead>
                    <tr class="">
                        <th scope="col">Nome</th>
                        <th scope="col">Email</th>
                        <th scope="col">Nicho</th>
                        <th scope="col">Qualidade</th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody th:if="${propriedade != null}">
                    <tr class="border user-row"
                        th:id="${fornecedor.getId()}"
                        th:each="fornecedor : ${propriedade.getFornecedores()}">
                        <td class="fornecedorID"
                            th:id="${fornecedor.getId()}"
                            th:text="${fornecedor.getNome()}"></td>
                        <td th:text="${fornecedor.getEmail()}"></td>
                        <td th:text="${fornecedor.getNicho()}"></td>
                        <td th:text="${fornecedor.getQualidade()}"></td>
                        <td>

                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade"
         id="amostraModal"
         tabindex="-1"
         aria-labelledby="amostraModal
                    aria-hidden="
         true>
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">

                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="conteudo-index p-3"
                         style="max-height:88vh">
                        <div class="border border-black  w-100 h-100 "
                             style="border-radius: 55px;">
                            <div class="border border-black w-100 p-4 rounded-pill shadow-lg ">
                                <h1>Nova Amostra</h1>
                            </div>
                            <div class="w-100 flex-column align-items-center d-flex justify-content-start p-5"
                                 style="height: auto;">
                                <form class="w-100"
                                      action="/amostras"
                                      method="post">
                                    <input type="hidden"
                                           name="propriedadeId"
                                           th:value="${propriedade.getIdPropriedade()}">
                                    <div class="mb-3">
                                        <div class="mb-3 d-flex-row align-items-center">
                                            <h4 class="ms-2 me-2">Data de emissão</h4>
                                            <input name="data"
                                                   type="date"
                                                   style="border-color: #273C4E; width: 230px;"
                                                   class="form-control rounded-pill"
                                                   aria-describedby="emailHelp"
                                                   placeholder="Nome">
                                        </div>

                                        <div class="mb-3 d-flex-row align-items-center">
                                            <h4 class="ms-2 me-2">Amostra</h4>
                                            <input disabled
                                                   type="file"
                                                   style="border-color: #273C4E;"
                                                   class="form-control rounded-pill w-100"
                                                   aria-describedby="emailHelp"
                                                   placeholder="Nome">
                                        </div>

                                        <div class=" m-0 p-0 mb-5 w-100">
                                            <div class="row">
                                                <div class="col-4 align-items-center">
                                                    <h4 class="ms-2 me-2">Quantidade/Queijo</h4>
                                                    <input name="quantidadeQueijo"
                                                           type="number"
                                                           style="border-color: #273C4E; width: 230px;"
                                                           class="form-control rounded-pill"
                                                           aria-describedby="emailHelp"
                                                           placeholder="Kg">
                                                    <h4 class="ms-2 me-2 mt-2">Quantidade/Leite</h4>
                                                    <input name="quantidadeleite"
                                                           type="number"
                                                           style="border-color: #273C4E; width: 230px;"
                                                           class="form-control rounded-pill"
                                                           aria-describedby="emailHelp"
                                                           placeholder="Litros">
                                                </div>
                                                <div class="col align-items-center">
                                                    <h4>Observações</h4>
                                                    <textarea name="observacao"
                                                              type="Text"
                                                              style="border-color: #273C4E; height:77%;"
                                                              class="form-control w-100 "
                                                              aria-describedby="emailHelp"
                                                              placeholder=""></textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end w-auto">
                                            <button th:text="${amostra != null}? 'Cadastrar' : 'Cadastrar'"
                                                    type="submit"
                                                    class="btn btn-success rounded-pill fs-4 px-5 shadow"
                                                    style="width: 200px;">Salvar
                                            </button>
                                        </div>
                                    </div>
                                </form>

                                <form th:if="${usuario != null}"
                                      th:action="@{/usuarios/delete/{id}(id=${usuario.idUsuario})}"
                                      th:method="delete">
                                    <div class="d-flex justify-content-end w-auto">
                                        <button type="submit"
                                                th:text="${amostra != null}? 'Cadastrar' : 'Cadastrar'"
                                                class="btn btn-danger rounded-pill fs-4 px-5 mt-2 shadow"
                                                style="width: 200px;"
                                                data-bs-dismiss="modal">Sair
                                        </button>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function removerAmostra(id) {
            $.ajax({
                url: '/amostra/delete/' + id,
                type: 'DELETE',
                success: function (response) {
                    // Remover a linha da tabela DataTables
                    var dataTable = $('#myTable').DataTable();
                    dataTable.row('#' + id).remove().draw();
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.error(error)
                }
            });
        }
    </script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        function updateMap(latitude, longitude) {
            var iframe = document.getElementById('map');
            var iframeSrc = `https://maps.google.com/maps?width=100%&height=300&hl=en&q=${latitude},${longitude}&t=&z=13&ie=UTF8&iwloc=B&output=embed`;
            iframe.src = iframeSrc;
        }

        var latitude = /*[[${propriedade.latitude}]]*/ 'default_latitude';
        var longitude = /*[[${propriedade.longitude}]]*/ 'default_longitude';

        updateMap(latitude, longitude);
        /*]]>*/
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript"
            charset="utf8"
            src="//cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script type="text/javascript"
            charset="utf8"
            src="https://cdn.datatables.net/plug-ins/1.11.5/sorting/date-eu.js"></script>
    <script>
        $(document).ready(function () {
            $('#usuarioTable').DataTable();
        });
        new DataTable('#usuarioTable');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        $.fn.dataTable.ext.type.order['date-br-pre'] = function (data) {
            var parts = data.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        };

        $(document).ready(function () {
            $('#myTable').DataTable({
                paging: false,
                scrollCollapse: true,
                lengthChange: false,
                info: false,
                columnDefs: [
                    {type: 'date-br', targets: 1}
                ],

            });
        });
    </script>
    <script>
        var dadosProducao = {};

        function inicializarDados() {
            var linhas = document.querySelectorAll("#myTable tbody tr");

            linhas.forEach(function (linha) {
                var colunas = linha.getElementsByTagName("td");
                var data = colunas[1].textContent.trim();
                var quantidadeLeite = parseInt(colunas[2].textContent.trim(), 10);
                var quantidadeQueijo = parseInt(colunas[3].textContent.trim(), 10);

                var partesData = data.split("/");
                var ano = partesData[2];
                var mes = parseInt(partesData[1], 10);

                if (!dadosProducao[ano]) {
                    dadosProducao[ano] = {};
                }

                if (!dadosProducao[ano][mes]) {
                    dadosProducao[ano][mes] = {
                        leite: 0,
                        queijo: 0
                    };
                }

                dadosProducao[ano][mes].leite += quantidadeLeite;
                dadosProducao[ano][mes].queijo += quantidadeQueijo;
            });
        }

        inicializarDados();

        var options = {
            series: [{
                name: 'Leite',
                data: []
            }, {
                name: 'Queijo',
                data: []
            }],
            chart: {
                height: 350,
                type: 'bar',
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                },
            },
            dataLabels: {
                enabled: true
            },
            stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                categories: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
            },
            yaxis: {
                title: {
                    text: 'Quantidade'
                }
            },
            fill: {
                opacity: 1
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val + " unidades"
                    }
                }
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);

        chart.render();

        function filtrarPorAno(anoSelecionado) {
            var dataLeite = [];
            var dataQueijo = [];

            if (dadosProducao[anoSelecionado]) {
                // Loop pelos meses de 1 a 12
                for (var i = 1; i <= 12; i++) {
                    if (dadosProducao[anoSelecionado][i]) {
                        dataLeite.push(dadosProducao[anoSelecionado][i].leite);
                        dataQueijo.push(dadosProducao[anoSelecionado][i].queijo);
                    } else {
                        dataLeite.push(0);
                        dataQueijo.push(0);
                    }
                }
            } else {
                dataLeite = Array(12).fill(0);
                dataQueijo = Array(12).fill(0);
            }

            chart.updateSeries([{
                name: 'Leite',
                data: dataLeite
            }, {
                name: 'Queijo',
                data: dataQueijo
            }]);
        }


        function atualizarSelectAnos() {
            var selectAno = document.getElementById('selectYear');
            var anosDisponiveis = Object.keys(dadosProducao);

            selectAno.innerHTML = '';

            anosDisponiveis.sort(function (a, b) {
                return b - a;
            });

            anosDisponiveis.forEach(function (ano) {
                var option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                selectAno.appendChild(option);
            });

            if (anosDisponiveis.length > 0) {
                filtrarPorAno(anosDisponiveis[0]);
            }
        }

        atualizarSelectAnos();
    </script>
</div>
</body>
</html>
